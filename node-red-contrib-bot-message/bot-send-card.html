<script type="text/javascript">
    RED.nodes.registerType('send-card',{
        category: 'VISEO_BOT',
        color: '#3FADB5',
        defaults: {
            name:         { value: undefined },
            labels:       { value: ["Default output"] },
            nodeid:       { value: undefined, validate: function(value) {
                if (!value.match(/^[a-zA-Z0-9_.-]*$/ig)) return false;
                var result = 0;
                RED.nodes.eachNode(function(node) {
                    if      (node.type !== 'send-card') return;
                    else if (node.nodeid === value)     result++;
                })
                return (result > 1) ? false : true;
            }},
            delay:        { value: undefined },
            repeat:       { value: 0 },
            outputs:      { value: 1 },
            btnOutput:    { value: undefined },
            quickOutput:  { value: undefined },

            prompt:       { value: undefined },
            promptText:   { value: "prompt.text" },
            promptTextType:   { value: "msg" },
            speech:       { value: true },
            speechText:   { value: undefined },

            sendType:     { value: "text" },

            text:         { value: undefined },
            random:       { value: undefined },

            media:        { value: undefined },
            mediaType:    { value: "str" },

            eventName:      { value: undefined },
            eventValue:     { value: undefined },
            eventValueType: { value: "str" },

            title:        { value: undefined },
            titleType:    { value: "str" },
            subtitle:     { value: undefined },
            subtext:      { value: undefined },
            attach:       { value: undefined },
            attachType:   { value: "str" },
            carousel:     { value: undefined },
            buttons:      { value: [{ title: "", action:"postBack", value:"", regexp:""}]  },

            quicktext:    { value: undefined },
            quickreplies: { value: [{ title: "", action:"postBack", value:"", regexp:""}]  },

            signintext:   { value: undefined },
            signintitle:  { value: undefined },
            signintitleType:  { value: "str" },
            signinurl:    { value: undefined },
            signinurlType:    { value: "str" },

            confirmtext : {value: undefined },

            shcardtext:      { value: undefined },
            shcardtitle:     { value: undefined },
            shcardtitleType:     { value: "str" },
            shcardimage:     { value: undefined },
            shcardimageType:     { value: "str" },
            shcardbutton:    { value: undefined },
            shcardbuttonType:    { value: "str" },
            shcardurl:       { value: undefined },
            shcardurlType:       { value: "str" },
            titleAdaptiveCard:        { value: undefined },
            titleTypeAdaptiveCard:    { value: "str" },
            textAdaptiveCard:      { value: undefined },
            subtextAdaptiveCard:      { value: undefined },
            attachAdaptiveCard:       { value: undefined },
            displayedTextSizeAdaptiveCard: {value: undefined},
            containerSeparatorAdaptiveCard: {value: "##"},
            metadata : { value : undefined },
            metadataType : { value : "str" }
        },
        inputs:  1,
        outputs: 1,
        outputLabels: function(index) {
            return this.labels[index];
        },
        oneditprepare: function () {

            // Typed Input
            $("#node-input-name").typedInput({         default: 'str', types: ['str'], type: 'str' });
            $("#node-input-eventName").typedInput({    default: 'str', types: ['str'], type: 'str' });
            $("#node-input-promptText").typedInput({   default: 'msg', types: ['msg'], type: 'msg' });
            $("#node-input-media").typedInput({        default: 'str', types: ['msg','global','str'], typeField: $("#node-input-mediaType")});
            $("#node-input-title").typedInput({        default: 'str', types: ['msg','global','str'], typeField: $("#node-input-titleType")});
            $("#node-input-attach").typedInput({       default: 'str', types: ['msg','global','str'], typeField: $("#node-input-attachType")});
            $("#node-input-signintitle").typedInput({  default: 'str', types: ['msg','global','str'], typeField: $("#node-input-signintitleType")});
            $("#node-input-signinurl").typedInput({    default: 'str', types: ['msg','global','str'], typeField: $("#node-input-signinurlType")});
            $("#node-input-shcardtitle").typedInput({  default: 'str', types: ['msg','global','str'], typeField: $("#node-input-shcardtitleType")});
            $("#node-input-shcardimage").typedInput({  default: 'str', types: ['msg','global','str'], typeField: $("#node-input-shcardimageType")});
            $("#node-input-shcardbutton").typedInput({ default: 'str', types: ['msg','global','str'], typeField: $("#node-input-shcardbuttonType")});
            $("#node-input-shcardurl").typedInput({    default: 'str', types: ['msg','global','str'], typeField: $("#node-input-shcardurlType")});
            $("#node-input-eventValue").typedInput({   default: 'str', types: ['msg','global','str', 'json'], typeField: $("#node-input-eventValueType")});
            $("#node-input-delay").typedInput({        default: 'num', types: ['num'], type: 'num' })
                .typedInput("width", "100px");
            $("#node-input-repeat").typedInput({       default: 'num', types: ['num'], type: 'num' })
                .typedInput("width", "100px");

            $("#node-input-titleAdaptiveCard").typedInput({      default: 'str', types: ['msg','global','str'], typeField: $("#node-input-titleTypeAdaptiveCard")});
            $("#node-input-attachAdaptiveCard").typedInput({     default: 'str', types: ['msg','global','str'], typeField: $("#node-input-attachTypeAdaptiveCard")});
            $("#node-input-displayedTextSizeAdaptiveCard").typedInput({   types: ['num'], type:'num'});
            $("#node-input-containerSeparatorAdaptiveCard").typedInput({   types: ['str'], type:'str'});
            $("#node-input-metadata").typedInput({default: 'str', types: ['msg','flow','global','str','num','bool','json'], typeField: $("#node-input-metadataType")});
            // Prompt and speech : show and hide fields
            $("#node-input-prompt").change( function() {
                if ($(this).is(":checked")) {
                    $("#prompt").show();
                    $("#node-input-promptText").typedInput('show');
                }
                else $("#prompt").hide();
            }).change();

            $("#node-input-speech").change( function() {
                if ($(this).is(":checked")) $(".display-speech").hide();
                else $(".display-speech").show();
            });


            $("#node-input-delay").change(function(e) {
                var val = $(this).val();
                if($('#node-input-delay-category').val() == "custom" && val < 200) {
                    $("#node-input-delay").val(200);
                }
            });

            $('#node-input-delay-category').change(function(e) {
                if($(this).val() == "default") {
                    $("#node-input-delay").val(0);
                    $("#node-input-delay-custom").hide();
                } else {
                    $("#node-input-delay-custom").show();
                    $("#node-input-delay").typedInput('show');
                    if($("#node-input-delay").val() == 0) {
                        $("#node-input-delay").val(this.delay || 2000);
                    }
                }
            });

            if(this.delay && this.delay != 0) {
                $('#node-input-delay-category').val('custom');
            } else {
                $('#node-input-delay-category').change();
            }

            // Type : show and hide sections
            $('#node-input-sendType').change(function (event) {
                var type = $(this).val();
                $('.section-type, .section-share').addClass('hide');
                $('.section-'+type).removeClass('hide');

                if (type === "event") {
                    $('.section-titles').addClass('hide');
                }
                else {
                    $('.section-titles').removeClass('hide');
                }

                if (type === "card") {
                    displaySharedCard()
                    $("#node-input-attach, #node-input-title").typedInput('show');
                }
                else if (type === "media") {
                    $("#node-input-media").typedInput('show');
                }
                else if (type === "signin") {
                    $("#node-input-signintitle, #node-input-signinurl").typedInput('show');
                }
                else if (type === "event") {
                    $("#node-input-eventValue, #node-input-eventName").typedInput('show');
                } 
                else if (type === "adaptiveCard") {
                    $("#node-input-attachAdaptiveCard, #node-input-titleAdaptiveCard, #node-input-displayedTextSizeAdaptiveCard, #node-input-containerSeparatorAdaptiveCard").typedInput('show');
                }
            });

            function addButtonItem( row, index, data ) {
                var button = data.btn,
                    title = '',
                    action = 'postBack',
                    value = '',
                    regexp = '';

                if (button) {
                    if (button.hasOwnProperty('title'))  title =  button.title;
                    if (button.hasOwnProperty('action')) action = button.action;
                    if (button.hasOwnProperty('value'))  value =  button.value;
                    if (button.hasOwnProperty('regexp')) regexp = button.regexp;
                }

                var hiddenField = $('<span/>', {}).appendTo(row);
                var titleField =  $('<input/>',  { class:"property-btn-title",  type:"text", style:"width:25%; margin-right:5px;", value: title,  placeholder:"Label"}).appendTo(row);
                var actionField = $('<select/>', { class:"property-btn-action", type:"text", style:"width:25%; margin-right:5px;"}).appendTo(row);
                    actionField.append($("<option></option>").val("postBack").text("Post Back"));
                    actionField.append($("<option></option>").val("imBack").text("IM Back"));
                    actionField.append($("<option></option>").val("openUrl").text("Open URL"));
                    actionField.append($("<option></option>").val("share").text("Share card"));
                    actionField.append($("<option></option>").val("showImage").text("Show Image"));
                    actionField.append($("<option></option>").val("playAudio").text("Play Audio"));
                    actionField.append($("<option></option>").val("playVideo").text("Play Video"));
                    actionField.append($("<option></option>").val("call").text("Call"));
                var valueField =  $('<input/>', { class:"property-btn-value",  type:"text", style:"width:20%; margin-right:5px;", value: value,  placeholder:"Value"}).appendTo(row);
                var regexpField = $('<input/>', { class:"property-btn-regexp", type:"text", style:"width:20%; margin-right:5px;", value: regexp, placeholder:"Regex"}).appendTo(row);
                    actionField.val(action).change();
            }; 

             // Buttons and quick replies : init
             $("#btn-container").css('min-height','100px').editableList({
              addItem: function ( row, index, data ) {
			            addButtonItem( row, index, data );
	          },
              sortable: true,
              removable: true
            });

           $("#btn-container-AdaptiveCard").css('min-height','100px').editableList({
              addItem: function ( row, index, data ) {
			            addButtonItem( row, index, data );
	          },
              sortable: true,
              removable: true
            });

            $("#qck-container").css('min-height','150px').editableList({
                addItem: function ( row, index, data ) {
                    var button = data.btn,
                        title = '',
                        action = 'postBack',
                        value = '',
                        regexp = '';

                    if (button) {
                        if (button.hasOwnProperty('title')) title =   button.title;
                        if (button.hasOwnProperty('action')) action = button.action;
                        if (button.hasOwnProperty('value')) value =   button.value;
                        if (button.hasOwnProperty('regexp')) regexp = button.regexp;
                    }

                    var hiddenField = $('<span/>', {}).appendTo(row);
                    var titleField =  $('<input/>',  { class:"property-qck-title",  type:"text", style:"width:25%; margin-right:5px;", value: title,  placeholder:"Label"}).appendTo(row);
                    var actionField = $('<select/>', { class:"property-qck-action", type:"text", style:"width:25%; margin-right:5px;"}).appendTo(row);
                        actionField.append($("<option></option>").val("postBack").text("Post Back"));
                        actionField.append($("<option></option>").val("imBack").text("IM Back"));
                        actionField.append($("<option></option>").val("askLocation").text("Location"));
                        actionField.append($("<option></option>").val("askIdentity").text("Identity"));
                    var valueField =  $('<input/>', { class:"property-qck-value",  type:"text", style:"width:20%; margin-right:5px;", value: value,  placeholder:"Value"}).appendTo(row);
                    var regexpField = $('<input/>', { class:"property-qck-regexp",  type:"text", style:"width:20%; margin-right:5px;", value: regexp,  placeholder:"Regex"}).appendTo(row);
                        actionField.val(action).change()
                },
                sortable: true,
                removable: true
            });

            // Buttons and quick replies : trigger action changes
            $(document).on('change', '.property-qck-action', function() {

                var $parent = $(this).parent();
                var $inputs = $parent.find('input');
                    $inputs.prop('disabled', false);

                if      ($(this).val() === 'askLocation' || $(this).val() === 'askIdentity')  $inputs.prop('disabled', true);
                else if ($(this).val() !== 'postBack' && $(this).val() !== 'imBack') {
                    $parent.find('.property-qck-regexp').prop('disabled', true);
                }
            }).change();

            $(document).on('change', '.property-btn-action', function() {
                var $parent = $(this).parent();
                var $inputs = $parent.find('input');
                    $inputs.prop('disabled', false);

                if  ($(this).val().match(/call|share/)) {
                    $inputs.prop('disabled', true);
                }
                else if ($(this).val() !== 'postBack' && $(this).val() !== 'imBack') {
                    $parent.find('.property-btn-regexp').prop('disabled', true);
                }
                displaySharedCard();
            }).change();

            // Get buttons and quick replies
            for (var i=0; i<this.buttons.length; i++) {
                var infos = this.buttons[i];
                $("#btn-container").editableList('addItem', { btn: infos, i:i });
                $("#btn-container-AdaptiveCard").editableList('addItem', { btn: infos, i:i });
            }
            for (var i=0; i<this.quickreplies.length; i++) {
                var infos = this.quickreplies[i];
                $("#qck-container").editableList('addItem', { btn: infos, i:i });
            }

            // ID : set a random one
            if (!this.nodeid) newID();
            $('#refresh-config').on("click", newID);

            // ID : change id
            var trueid = this.id;
            $('#node-input-nodeid').change(function (event) {
                var id = $(this).val().replace(/ /g, '_');
                if (!id.match(/^[a-zA-Z0-9_.-]*$/ig)) {
                    $(this).addClass("input-error");
                }
                else if (checkNodeID(id, trueid)) {
                    $('#node-input-nodeid').val(id);
                    $(this).removeClass("input-error");
                }
                else  $(this).addClass("input-error");
            });

            function newID() {
                let result = false;
                let nodeid = "";
                for (let i=0; i<500 && !result; i++) {
                    nodeid = "SEND_" + Date.now();
                    result = (checkNodeID(nodeid));
                }
                $('#node-input-nodeid').val(nodeid);
                $('#node-input-nodeid').removeClass("input-error");
            }

            function displaySharedCard() {
                $('.section-share').addClass('hide');
                if ($('#node-input-sendType').val() !== "card") return;
                let butt = $("#btn-container").editableList('items');
                butt.each(function(){
                    if ($(this).find('.property-btn-action').val() === "share") {
                        $('.section-share').removeClass('hide');
                        $("#node-input-shcardtitle, #node-input-shcardimage").typedInput('show');
                        $("#node-input-shcardbutton, #node-input-shcardurl").typedInput('show');
                    }
                })
            }

        },
        oneditsave: function(){

             // Buttons
            let butt;
            var type = $('#node-input-sendType').val();
            if (type === 'adaptiveCard'){
              butt = $("#btn-container-AdaptiveCard").editableList('items');
            } else {
              butt = $("#btn-container").editableList('items');
            }
            let quic = $("#qck-container").editableList('items');
            let results = new Array();

            butt.each(function(i) {
                var btn = {
                    title  : $(this).find('.property-btn-title').val(),
                    action : $(this).find('.property-btn-action').val(),
                    value  : $(this).find('.property-btn-value').val(),
                    regexp : $(this).find('.property-btn-regexp').val(),
                }
                if ((btn.title && btn.value) || btn.action === 'share') { results.push(btn); }
            });
            this.buttons = (results.length === 0) ? [{ title: "", action:"postBack", value:"", regexp:""}] : results;

            results = new Array();
            quic.each(function(i) {
                var btn = {
                    title  : $(this).find('.property-qck-title').val(),
                    action : $(this).find('.property-qck-action').val(),
                    value  : $(this).find('.property-qck-value').val(),
                    regexp : $(this).find('.property-qck-regexp').val(),
                }
                if ((btn.title && btn.value) || btn.action.match(/askLocation|askIdentity/)) { results.push(btn); }
            });
            this.quickreplies = (results.length === 0) ? [{ title: "", action:"postBack", value:"", regexp:""}] : results;

            // Outputs and labels
            let labels = new Array();
            this.delay  = $('#node-input-delay').val();
            this.repeat = $('#node-input-repeat').val() || 0;
            this.outputs = 1 ;

            var type = $('#node-input-sendType').val();
            if (type === 'card' || type === 'adaptiveCard'){
                var btnOut = $('#node-input-btnOutput').is(':checked')
                if (btnOut) {
                    labels.push("Unexpected");
                    let len = this.buttons.length;
                    this.outputs += len;
                    for (let i=0; i<len; i++) {
                        labels.push("Button " + (this.buttons[i].title || this.buttons[i].action));
                    }
                }
            } else if (type === 'quick') {
                var quickOut = $('#node-input-quickOutput').is(':checked')
                if (quickOut) {
                    labels.push("Unexpected");
                    let len = this.quickreplies.length;
                    this.outputs += len;
                    for (let i=0; i<len; i++) {
                        labels.push("Quickreply " + (this.quickreplies[i].title || this.quickreplies[i].action));
                    }
                }
            }

            this.labels = (labels.length > 0) ? labels : ["Default output"];

            if  (this.repeat > 0) {
                this.labels.push("Repeat");
                this.outputs ++;
            }
        },
        icon: function() {
            if (this.sendType === "text")   return "text.svg";
            if (this.sendType === "media")  return "picture.svg";
            if (this.sendType === "quick")  return "buttons.svg";
            if (this.sendType === "signin") return "fingerprint.svg";
            if (this.sendType === "event")  return "tech.svg";
            if (this.carousel === true)     return "carousel.svg";
            return "card.svg";
        },
        align: "left",
        paletteLabel: "Message",
        labelStyle: "bot-card-name",
        label: function() {
            if (this.name) return this.name;
            if (this.carousel === true) return "Card";
            if (this.sendType === "text" || this.sendType === "quick")  { 
                if (this.text) {
                    if (this.text.length <= 20) return "Send: \"" + this.text + "\"";
                    else return "Send: \"" + this.text.substring(0,17) + '...\"';
                }
                else return "Send: \"\"";
            }
            if (this.sendType === "card")   return "Send card";
            if (this.sendType === "adaptiveCard")  return "Send card"; 
            if (this.sendType === "media")  return "Send media"; 
            if (this.sendType === "signin") return "Send signin";
            if (this.sendType === "event")  return "Send event";
            else return "Send Card";
        }
    });

    function checkNodeID(nodeid, id) {
        var result = true;
        RED.nodes.eachNode(function(node) {
            if (node.type !== 'send-card') return;
            else if (node.id === id) return;
            else if (node.nodeid === nodeid) result = false;
        })
        return result;
    }

    RED.events.on("nodes:add", function(node){
        if (node.type !== 'send-card') return;
        if (!node.nodeid) {
            let result = false;
            let nodeid = "";
            for (let i=0; i<500 && !result; i++) {
                nodeid = "SEND_" + Date.now();
                result = (checkNodeID(nodeid));
            }
            node.nodeid = nodeid;
        }
        if (node.outputs) return;
        node.outputs = 1;
    });

    $(document).ready(function() {
        // Toggle TabPane
        $(document).on('click', '#send-card-tabs .red-ui-tab-label', function(){
            $('.send-card-panel').addClass('hide');
            $('.send-card-tab').removeClass('active');
            var $this = $(this);
            var panelId = '#send-card-' + $this.attr('href').substring(1);

            $(panelId).removeClass('hide');
            $this.parent('.send-card-tab').addClass('active');

            $("#node-input-promptText").typedInput('show');
            $("#node-input-name").typedInput('show');
            $("#node-input-delay").typedInput('show');
            $("#node-input-repeat").typedInput('show');
        })
        // info section
        $(document).on('click', '#send-card-tabs-help .red-ui-tab-label', function(){
            $('.send-card-panel-help').addClass('hide');
            $('.send-card-tab-help').removeClass('active');
            $('#help-types .node-info-header').removeClass('expanded');
            $('#help-buttons .node-info-header').removeClass('expanded');
            $('#help-types p').hide();
            $('#help-buttons p').hide();
            $('#help-buttons pre').hide();
            var $this = $(this)
            var panelId = $this.attr('href');
            $(panelId).removeClass('hide');
            $this.parent('.send-card-tab-help').addClass('active');
        })
    });
</script>

<style>
    textarea {
        overflow-y: scroll;
        overflow-x: hidden;
        min-height: 60px;
        max-width: 100%;
        width:80%;
        resize: vertical;
    }
    .red-ui-editableList-border.red-ui-editableList-container {
        overflow-x: hidden;
        resize: vertical;
    }
</style>

<script type="text/x-red" data-template-name="send-card">

    <div class="red-ui-tabs" style="margin-bottom: 10px; min-width:600px;">
        <div>
            <ul id="send-card-tabs">
                <li class="send-card-tab active" style="min-width:150px; margin-left:20px;">    <a href="#msg"  class="red-ui-tab-label"><span class="bidiAware" dir="">Content</span></a></li>
                <li class="send-card-tab"        style="min-width:150px;">                      <a href="#sett" class="red-ui-tab-label"><span class="bidiAware" dir="">Settings</span></a></li>
            </ul>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="send-card-sett" class="send-card-panel hide">

        <br>
        <b>Node</b>
        <div class="form-row">
            <br>
            <label for="node-input-name"><i class="icon-tag"></i> Name</label>
            <input type="text" id="node-input-name" placeholder="Name" style="width:80%;">
        </div>
        <div class="form-row">
            <label for="node-input-nodeid"><i class="icon-tag"></i> Unique ID</label>
            <input type="text" id="node-input-nodeid" placeholder="Unique send-message node ID" style="width: calc(80% - 36px)">
            <a id="refresh-config" class="editor-button" style="display:inline-block; vertical-align:middle; ">
                <i class="fa fa-refresh"></i>
            </a>
        </div>


        <br>
        <b>Message</b>
        <div class="form-row">
            <br>
            <label for="node-input-prompt"><i class="fa fa-sign-in"></i> Prompt</label>
            <input type="checkbox" style="width: auto; vertical-align:top;" id="node-input-prompt"> <span>Require a user input/answer</span>
        </div>

        <div class="form-row" id="prompt">
            <label for="node-input-promptText"></label>
            <input type="text" id="node-input-promptText" style="width: 80%;" placeholder="prompt.text">
        </div>

        <div class="form-row">
            <label for="node-input-carousel"><i class="fa fa-th"></i> Carousel</label>
            <input type="checkbox" id="node-input-carousel" style="width: auto; vertical-align:top;"> <span>Do not send message, add to the next card</span>
        </div>

        <div class="form-row section-type section-card">
            <label for="node-input-btnOutput"><i class="fa fa-sign-out"></i> Outputs</label>
            <input type="checkbox" id="node-input-btnOutput" style="width: auto; vertical-align:top;"> <span>Add outputs for each button</span>
        </div>

        <div class="form-row section-type section-quick">
            <label for="node-input-quickOutput"><i class="fa fa-sign-out"></i> Outputs</label>
            <input type="checkbox" id="node-input-quickOutput" style="width: auto; vertical-align:top;"> <span>Add outputs for each quick reply</span>
        </div>

        <div class="form-row">
            <label for="node-input-delay"><i class="fa fa-clock-o"></i> Delay</label>
            <select id="node-input-delay-category">
                <option value="default">default</option>
                <option value="custom">custom</option>
            </select>
            <div id="node-input-delay-custom" style="display:inline-block">
                <input type="text" id="node-input-delay" > 
                <p style="display: inline-block;"> ms</p>
            </div>
        </div>

        <div class="form-row" >
            <label for="node-input-repeat"><i class="fa fa-repeat"></i> Repeat</label>
            <input type="number" min="0" id="node-input-repeat" placeholder="0">
            <p style="display: inline-block;"> times</p>
        </div>
    </div>


    <div id="send-card-msg"  class="send-card-panel ">

        <br>
        <div class="form-row">
            <label for="node-input-sendType"><i class="fa fa-square-o"></i> Type</label>
            <select id="node-input-sendType" style="width:80%;">
                <option value="text">Text</option>
                <option value="quick">Text + Quick replies</option>
                <option value="media">Image</option>
                <option value="card">Card</option>
                <option value="signin">SignIn</option>
                <option value="event">Event</option>
                <option value="adaptiveCard">AdaptiveCard</option>
                <option value="confirm">Confirm</option>
            </select>
        </div>
        <br>

        <section class="section-titles">
            <b>Displayed content</b>
            <br><br>
        </section>
    
        <section class="section-type section-text">
            <div class="form-row">
                <label for="node-input-text"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-text" rows="4" placeholder="Text to send"></textarea>
            </div>
        </section>

        <section class="section-type section-media">
            <div class="form-row">
                <label for="node-input-media"><i class="fa fa-image"></i> Image</label>
                <input type="text" id="node-input-media" style="width:80%;" placeholder="http://path/to/card/image">
                <input type="hidden" id="node-input-mediaType">
            </div>
        </section>
        <section class="section-type section-card">
            <div class="form-row">
                <label for="node-input-title"><i class="fa fa-pencil-square-o"></i> Title</label>
                <input type="text" id="node-input-title" style="width:80%;">
                <input type="hidden" id="node-input-titleType">
            </div>
            <div class="form-row">
                <label for="node-input-subtitle"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-subtitle" rows="4" placeholder="Text to send"></textarea>
            </div>

            <div class="form-row">
                <label for="node-input-subtext"><i class="fa fa-pencil-square-o"></i> SubText</label>
                <textarea id="node-input-subtext" rows="1" placeholder="SubText to send"></textarea>
            </div>

            <div class="form-row">
                <label for="node-input-attach"><i class="fa fa-image"></i> Image</label>
                <input type="text" id="node-input-attach" style="width:80%;" placeholder="http://path/to/card/image">
                <input type="hidden" id="node-input-attachType">
            </div>
        </section>
        <section class="section-type section-adaptiveCard">
            <div class="form-row">
                <label for="node-input-titleAdaptiveCard"><i class="fa fa-pencil-square-o"></i> Title</label>
                <input type="text" id="node-input-titleAdaptiveCard" style="width:80%;">
                <input type="hidden" id="node-input-titleTypeAdaptiveCard">
            </div>
            <!--<div class="form-row">
                <label for="node-input-subtextAdaptiveCard"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-subtextAdaptiveCard" rows="4" placeholder="Text to send"></textarea>
            </div>-->
            <div class="form-row">
                <label for="node-input-textAdaptiveCard"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-textAdaptiveCard" rows="4" placeholder="Text to send"></textarea>
            </div>
            <div class="form-row">
                <label  for="node-input-displayedTextSizeAdaptiveCard"> Wrap text up to </label>
                <input type="number" id="node-input-displayedTextSizeAdaptiveCard">
                </div>
                <div class="form-row">
                    <label for="node-input-containerSeparatorAdaptiveCard"> Container separator </label>
                    <input type="text" id="node-input-containerSeparatorAdaptiveCard">
                </div>
                <div class="form-row">
                <label for="node-input-attachAdaptiveCard"><i class="fa fa-image"></i> Image</label>
                <input type="text" id="node-input-attachAdaptiveCard" style="width:80%;" placeholder="http://path/to/card/image">
                <input type="hidden" id="node-input-attachTypeAdaptiveCard">
            </div>
        </section>

        <section class="section-type section-quick">
            <div class="form-row">
                <label for="node-input-quicktext"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-quicktext" rows="4" placeholder="Text to send"></textarea>
            </div>
        </section>

        <section class="section-type section-signin">
            <div class="form-row">
                <label for="node-input-signintext"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-signintext" rows="4" placeholder="Text to send"></textarea>
            </div>
            <div class="form-row">
                <label for="node-input-signintitle"><i class="fa fa-arrow-circle-o-right"></i> Button</label>
                <input type="text" id="node-input-signintitle" placeholder="Sign in" style="width:80%;">
                <input type="hidden" id="node-input-signintitleType">
            </div>
            <div class="form-row">
                <label for="node-input-signinurl"><i class="fa fa-globe"></i> URL</label>
                <input type="text" id="node-input-signinurl" placeholder="https://url.to/auth" style="width:80%;">
                <input type="hidden" id="node-input-signinurlType">
            </div>
        </section>  

        <section class="section-type section-confirm">
            <div class="form-row">
                <label for="node-input-confirmtext"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-confirmtext" rows="4" placeholder="Text to send"></textarea>
            </div>
        </section>     

        <section class="section-type section-text section-quick">
            <div class="form-row">
                <label for="node-input-random"><i class="fa fa-random"></i> Random</label>
                <input type="checkbox" style="width: auto; vertical-align:top;  margin-left:20px;" id="node-input-random"> <span>Choose randomly between each lines of text</span>
            </div>
        </section>
        <section class="section-type section-event">
            <div class="form-row">
                <label for="node-input-eventName"><i class="fa fa-tag"></i> Label</label>
                <input type="text" id="node-input-eventName" placeholder="event" style="width:80%;">
            </div>
            <div class="form-row">
                <label for="node-input-eventValue"><i class="fa fa-edit"></i> Value</label>
                <input type="text" id="node-input-eventValue" style="width:80%;" placeholder="">
                <input type="hidden" id="node-input-eventValueType">
            </div>
        </section>

        <section class="section-titles">

            <br>
            <b>Played content</b>
            <br><br>

            <div class="form-row">
                <label for="node-input-speech"><i class="fa fa-comment-o"></i> Speech</label>
                <input type="checkbox" id="node-input-speech" style="width: auto; vertical-align:top; margin-left:20px;" > <span>Convert text to speech</span>
            </div>

            <div class="form-row display-speech">
                <label for="node-input-speechText"><i class="fa fa-commenting-o"></i> Text</label>
                <textarea id="node-input-speechText" rows="2" placeholder="Text to say"></textarea>
            </div>

        </section>


        <section class="section-type section-quick">
            <br>
            <b>Quick replies</b>
            <br><br>

            <div class="form-row" style="width:97%;">
                <ol id="qck-container"></ol>
            </div>

        </section>

        <section class="section-type section-card">
            <br>
            <b>Buttons</b>
            <br><br>

            <div class="form-row" style="width:97%;">
                <ol id="btn-container"></ol>
            </div>
        </section>

        <section class="section-type section-adaptiveCard">
            <br>
            <b>Buttons</b>
            <br><br>

            <div class="form-row" style="width:97%;">
                <ol id="btn-container-AdaptiveCard"></ol>
            </div>
        </section>

        <section class="section-type section-share">
            <br>
            <b>Shared card</b>
            <br><br>

            <div class="form-row">
                <label for="node-input-shcardtitle"><i class="fa fa-pencil-square-o"></i> Title</label>
                <input type="text" id="node-input-shcardtitle" style="width:80%;">
                <input type="hidden" id="node-input-shcardtitleType">
            </div>
            <div class="form-row">
                <label for="node-input-shcardtext"><i class="fa fa-pencil-square-o"></i> Text</label>
                <textarea id="node-input-shcardtext" rows="4" placeholder="Text to send"></textarea>
            </div>

            <div class="form-row">
                <label for="node-input-shcardimage"><i class="fa fa-image"></i> Image</label>
                <input type="text" id="node-input-shcardimage" style="width:80%;" placeholder="http://path/to/card/image">
                <input type="hidden" id="node-input-shcardimageType">
            </div>

            <div class="form-row">
                <label for="node-input-shcardbutton"><i class="fa fa-arrow-circle-o-right"></i> Button</label>
                <input type="text" id="node-input-shcardbutton" placeholder="Sign in" style="width:80%;">
                <input type="hidden" id="node-input-shcardbuttonType">
            </div>
            <div class="form-row">
                <label for="node-input-shcardurl"><i class="fa fa-globe"></i> URL</label>
                <input type="text" id="node-input-shcardurl" placeholder="https://url.to/auth" style="width:80%;">
                <input type="hidden" id="node-input-shcardurlType">
            </div>
        </section>
        <br/>
        <div class="form-row">
                <label for="node-input-metadata"><i class="fa fa-database"></i> Metadata</label>
                <input type="text" id="node-input-metadata" style="width:80%;">
                <input type="hidden" id="node-input-metadataType">
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="send-card">

    <p>Sends messages to users using bot connectors. </p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>buttons <span class="property-type">array</span></dt>
        <dd>override the buttons with a Button array; don't forget to delete the field after using it. 
<pre type="javascript" style="width:400px"> 
    msg.buttons = [];
    msg.buttons.push({
        title  : 'Choice 1',
        action : 'postBack',
        value  : 'choice1',
        regexp : 'one|first|choice 1'
    });     
</pre>
        </dd>

        <dt>notification <span class="property-type">boolean</span></dt>
        <dd>Specifies if the message should trigger a notification. The value is unset once used. Please note that this option is currently only active with Facebook Messenger. 
<pre type="javascript" style="width:400px"> 
    msg.notification = true;     
</pre>
        </dd>
    </dl>

    <h3>Details: content</h3>
    <p>Chose a message type and complete the required informations to send it to the active user. 
        Be careful, some types are not availables for all sources.</p>
    <p>Types</p>
    <dl class="message-properties">
        <dt>Text</dt>
        <dd>text to send to the user; if you check <i>Random</i>, the the program choses a random line between each lines of text </dd>
        <dt>Text + Quick replies</dt>
        <dd>same behavior as behind, but with buttons; if no button is set and <code>msg.buttons</code> is empty, then acts like <i>Text</i>.</dd>
        <dt>Image</dt>
        <dd>sends an image to the user; the <i>Image</i> input must be a path to the image (serveur or url)</dd>
        <dt>Card</dt>
        <dd>sends a card to the user, with possible image, text and buttons; if <i>Carousel</i> is checked, the card will not be sent;
            the program will wait for another card (with the option unchecked) to send all the cards as a carousel </dd>
        <dt>AdaptiveCard</dt>
        <dd>sends a card to the user, with possible image, text and buttons; The card can trim the content with a <i>More</i> button,
            if the option <i>Wrap text up to</i> is filled in with the number of characters to display (i.e.
            If you only want to display 200 characters in the card, fill <i>Wrap text up to</i> with <i>200</i>).
            This card can also interpret Markdown text, creating buttons (containers) in the card for each Markdown section. To define a Markdown section,
            fill in the field <i>Container separator</i> with the character separating each section. For more details, see the 
            <a href="https://docs.microsoft.com/en-us/adaptive-cards/authoring-cards/getting-started">Adaptive Cards Documentation</a>.
        </dd>
        <dt>SignIn</dt>
        <dd>sends card to signin to an account; a signin URL should be precised</dd>
        <dt>Event</dt>
        <dd>sends an event (label and value - object) to the bot connector</dd>
        
    </dl>
    <p>Buttons and quick replies</p>
    <dl class="message-properties">
        <dt>Post Back / IM Back </dt>
        <dd>when the user clicks the button, the <i>Value</i> is sent into the flow</dd>
        <dt>Location</dt>
        <dd>asks the user to send its location (Messenger), then sends it into the flow as an attachment</dd>
        <dt>Identity</dt>
        <dd>asks the user to send information (Google Home / Assistant only)</dd>
        <dt>Call</dt>
        <dd>calls the number (Skype only)</dd>
        <dt>Share</dt>
        <dd>shares a card with a friend (Messenger only)</dd>
        <dt>Show image</dt>
        <dd>shows an image; the value must be a path to the image to display - URL (computers)/ image (cellphones)</dd>
        <dt>Play audio/video</dt>
        <dd>play the media; the value must be a path to the media to send</dd>
    </dl>

    <p><b>Note:</b> if your bot is a vocal application, then customize the played content: uncheck the <i>Speech</i> checkbox. </p>
    
    <p>Metadata</p>
    <p>Custom data associated to the message.</p>

    <h3>Details: settings</h3>
    <p>Properties</p>
    <dl class="message-properties">
        <dt>Unique ID <span class="property-type">string</span></dt>
        <dd>can be used to import/export send-card nodes in your flows</dd>
        <dt>Repeat <span class="property-type">number</span></dt>
        <dd>uses n times the 'default' output (first output), and then uses the 'repeat' output (last output)</dd>
        <dt>Delay <span class="property-type">number</span></dt>
        <dd>Overide the global delay before sending the message. (Minimum possible 200ms)</dd>
    </dl>
    <p>
        The <i>Prompt</i> checkbox is checked if the message should wait for a user answer or input. The <i>Outputs</i>
        checkbox adds n outputs to the node, depending on the number of buttons or quickreplies.
    </p>

    <h3>References</h3>
    <ul>
        <li><a href="https://developers.facebook.com/docs/messenger-platform/send-api-reference/generic-template">Cards example</a> - Messenger generic templates</li>
        <li><a href="https://developers.facebook.com/docs/messenger-platform/send-api-reference/quick-replies">Quick replies example</a> - Messenger quick replies</li>
        <li><a href="https://docs.microsoft.com/en-us/adaptive-cards/authoring-cards/getting-started">Adaptive Cards</a> - Adaptive Cards</li>
        <li><a href="https://github.com/NGRP/node-red-contrib-viseo/">VISEO BotMaker</a> - the nodes github repository</li>
    </ul>

</script>
